<link rel="import" href="../polymer/polymer-element.html">

<!--
`<a-timer>` is a countdown timer unusually capable to be driven by properties only.

```html
<a-timer start-at="30"></a-timer>
```

'Events' are signaled setting correspondent 'signal' property to true. 
And then to false again after the second passes. 

```html
<a-timer start-at="30" signal-finish="{{finished}}"></a-timer>
```

You can observe changes to `[[finish]]`, acting when it is set to true, 
as you would with an traditionally fired event.

`<a-timer>` may easily be attached to graphic elements.

```html
<a-timer start-at="30" current-time="{{currentTime}}"></a-timer>
[[currentTime]]
```

Start/stop `<a-timer>` by changing `run` property to true/false.
As you would with a traditional method, but using a property instead.

```html
<a-timer start-at="30" run="[[run]]"></a-timer>
```

Reset `<a-timer>` by changing `reset` property to true.
As you would with a traditional method, but using a property instead.
It will be reset at the instant the property changes to true.

```html
<a-timer start-at="30" reset="[[reset]]"></a-timer>
```

It may include one more optional alert `alert-also-at`, 
correspondingly signaled by `signal-alert-also-at`.

```html
<a-timer 
  start-at="30" 
  alert-also-at="10" 
  signal-alert-also-at="{{signalAlertAlsoAt}}" 
  signal-finish="{{finished}}>
</a-timer>
```

It may alert periodically.

```html
<a-timer start-at="30" alert-tick="2" signal-alert-tick="{{signalAlertTick}}"></a-timer>
```
A tick is meant to be higher than 1 second. For 1 second ticks, 
you can watch changes directly on `current-time` property, which updates every second. 

@element a-timer
@hero hero.svg
@demo demo/index.html
-->

<dom-module id="a-timer">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div class="time">[[currentTime]]</div>
  </template>

  <script>
    /**
     * `a-timer`
     * A countdown timer element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ATimer extends Polymer.Element {
      static get is() { return 'a-timer'; }
      static get properties() {
        return {
          /**
          * Start time in seconds.
          */
          startTime: {
            type: Number,
            value: 30,
          },

          /**
          * The current time in seconds.
          */
          currentTime: {
            type: Number,
            value: 30,
          },

          /**
          * An aditional time, in seconds, to alert.
          */
          alertAlsoAt: {
            type: Number,
            value: null,
          },

          /**
          * A period, in seconds, to alert periodically.
          */
          alertTick: {
            type: Number,
            value: null,
          },

          /**
          * A property, instead of a traditional method, to start/stop the timer.
          */
          run: {
            type: Boolean,
            value: false,
          },

          /**
          * A property, instead of a traditional event, to signal a periodic 'tick' alert set by ```alertTick```.
          */
          signalAlertTick: {
            type: Boolean,
            value: false,
          },

          /**
          * A property, instead of a traditional event, to signal an additional alert set by ```alertAt```.
          */
          signalAlertAlsoAt: {
            type: Boolean,
            value: false,
          },

          /**
          * A property, instead of a traditional event, to signal finish.
          */
          signalFinish: {
            type: Boolean,
            value: false,
          },

        };
      }

      static get observers() {
        return [
          '_runChanged(run)'
        ];
      }

      _runChanged(run) {
        console.log(run)
        run ? this.start() : this.stop();
      }

      /**
      * Starts the timer.
      */
      start() {
        this._resetAlerts();
        if (!this.time) this.time = performance.now();
        if (!this.running) {
          this.running = true;
          requestAnimationFrame(this._step.bind(this));
        }
      }

      /**
      * Stops the timer.
      */
      stop() {
        this.running = false;
        this.time = null;
      }

      /**
      * Resets the timer.
      */
      reset() {
        this._resetAlerts();
        this.set('currentTime', this.startTime);
      }

      _resetAlerts() {
        this.alreadyAlerted = false;
        this.set('signalFinish', false);
        this.set('signalAlertAlsoAt', false);
      }

      _step(timestamp) {
        if (!this.running) return;
        // this.calculate(timestamp);
        this.time = timestamp;
        this.exactTime = this.startTime - (this.time/1000);
        this.set('currentTime', Math.ceil(this.exactTime));
        console.log(this.currentTime)
        if (!this.alreadyAlerted && Math.floor(this.exactTime) < this.alertAt) {
          this.alreadyAlerted = true;
          // console.log('alert!');
          this.set('signalAlertAlsoAt', true);
          this.dispatchEvent(new CustomEvent('alert', {detail: this.currentTime}));        
        }        
        if (Math.floor(this.exactTime) <= 0) {
          this.set('currentTime', 0);
          this.alreadyAlerted = true;
          this.set('signalFinish', true);
          // console.log('alert!');
          this.dispatchEvent(new CustomEvent('finish'), {detail: this.currentTime});     
          console.log('oioi')
          this.set('run', false);
          // this.stop();
        }        
        // this.print();
        requestAnimationFrame(this._step.bind(this));
      }
    
      // calculate(timestamp) {
      //   var diff = timestamp - this.time;
      //   return (diff/1000);
      //   // Hundredths of a second are 100 ms
      //   this.times[2] += diff / 10;
      //   // Seconds are 100 hundredths of a second
      //   if (this.times[2] >= 100) {
      //       this.times[1] += 1;
      //       this.times[2] -= 100;
      //   }
      //   // Minutes are 60 seconds
      //   if (this.times[1] >= 60) {
      //       this.times[0] += 1;
      //       this.times[1] -= 60;
      //   }
      // }
      
      // print() {
      //     // this.display.innerText = this.format(this.times);
      // }
      
      // format(times) {
      //           return `\
      //   ${pad0(times[0], 2)}:\
      //   ${pad0(times[1], 2)}:\
      //   ${pad0(Math.floor(times[2]), 2)}`;
      // }

    }

    window.customElements.define(ATimer.is, ATimer);
  </script>
</dom-module>
